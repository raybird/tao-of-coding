# CLI 伴隨代理協議：進階範例與邊界情況

## 更多決策情境

### 多輪專案協作

若需連續處理同一專案的任務，請務必每次都傳入**完整的上下文**（如相關程式碼、依賴定義）。Sub-agent 為無狀態設計，不會保留前一次的記憶。

### 一次性格式轉換

用戶丟了一份 JSON，要轉成 YAML 並調整鍵名。使用 **opencode**（`opencode run`）。

### OpenCode 工作流

用戶在開源專案目錄下，要求「比對此目錄與上游的 diff，並產出中文摘要」。若專案採用 OpenCode 生態，選用 **opencode**。

---

## 何時「不要」卸載

- **任務極短、一兩句話可完成**：直接在主對話處理，避免多一層 CLI 呼叫開銷。
- **需要即時與用戶來回釐清**：委派後只拿回最終結果，不利多輪澄清；若預期會多次追問，優先在主對話完成。
- **涉及主 Agent 專屬工具或狀態**：例如需讀取主 Agent 才有的檔案、呼叫主 Agent 才註冊的 tool；這類任務不適合丟給 Sub-agent，因其無權存取。

---

## 錯誤處理與逾時

- Sub-agent CLI 應將**錯誤訊息**寫入 **stderr**，**最終回答**才寫 **stdout**。主 Agent 解析時可依此區分成功／失敗。
- 若 CLI 支援 `--timeout` 等參數，可對長時間任務設定上限，避免無限期等待。
- 當 Sub-agent 回傳非零 exit code 或 stderr 有內容時，主 Agent 應將錯誤資訊轉達用戶，或重試、改派其他子任務，而非假設一定有 stdout 結果。

## 查證型任務範例（外部事實）

當任務涉及價格、新聞、法規、版本、公告等可變動資訊時，輸出至少包含：

1. 使用的工具與命令（或查詢方式）
2. 來源連結
3. 查詢日期（YYYY-MM-DD）
4. 根據來源得出的結論（可區分「事實」與「推論」）

範例輸出格式：

```text
[角色路由]
Explorer + systematic-debugging（僅用於查證流程）

[查詢]
- Tool: web search
- Query: "SEC crypto task force latest updates"
- Date: 2026-02-10

[來源]
- https://www.sec.gov/...

[結論]
- 事實：SEC 已在 2025-01-21 公布 task force。
- 推論：短期內仍屬框架形成期，市場不確定性偏高。
```

---

## 選用哪一支 Sub-agent 的簡表

| 情境 | 建議 CLI | 無狀態策略 | Model |
|------|----------|---------|-------|
| 一般程式重構、文書、API 問答 | opencode | 每次傳入完整上下文 | `provider/model`（待團隊定義） |
| 開源工作流、特定程式庫 | opencode | 每次傳入完整上下文 | `provider/model`（待團隊定義） |
| 一次性格式轉換、簡單翻譯 | opencode | 單次指令 | `provider/model`（待團隊定義） |

以上邊界情況與範例可隨實作經驗增修。
